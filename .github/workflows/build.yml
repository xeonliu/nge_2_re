name: Build PSP Translation with Custom Docker

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-in-docker:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç  (æ‰‹åŠ¨ç®¡ç† Submodule)
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: false  # å…³é—­è‡ªåŠ¨ submodule
        fetch-depth: 0
        persist-credentials: false

    # 2. å¼ºåˆ¶ Git ä½¿ç”¨ PAT è®¿é—®æ‰€æœ‰ GitHub ä»“åº“
    - name: Configure Git & Update Submodules
      run: |
        # é…ç½® URL æ›¿æ¢ï¼Œå¼ºåˆ¶å¸¦ä¸Š Token
        git config --global url."https://${{ secrets.GIT_PAT }}@github.com/".insteadOf "https://github.com/"
        
        # ç°åœ¨æ‰‹åŠ¨æ›´æ–° submoduleï¼Œå®ƒä¼šä½¿ç”¨ä¸Šé¢çš„é…ç½®
        echo "â¬‡ï¸ Updating submodules..."
        git submodule update --init --recursive

    # 3. å®‰è£… HF CLI å¹¶ä¸‹è½½ ISO
    - name: Download ISO from Hugging Face
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_REPO_ID: ${{ secrets.HF_REPO_ID }}
      run: |
        echo "ğŸ“¦ Installing Hugging Face CLI..."
        curl -LsSf https://hf.co/cli/install.sh | bash
        export PATH="$HOME/.local/bin:$PATH"
        
        echo "â¬‡ï¸ Downloading ISO from Hugging Face Repo: $HF_REPO_ID..."
        mkdir -p temp
        hf download "$HF_REPO_ID" ULJS00064.iso \
          --repo-type model \
          --token "$HF_TOKEN" \
          --local-dir temp

    # 4. æ„å»º Docker é•œåƒ
    - name: Build Docker Image
      run: |
        docker build -t psp-builder .

    # 5. åœ¨å®¹å™¨å†…è¿è¡Œæ„å»º
    - name: Run Build inside Container
      env:
        AUTH_KEY: ${{ secrets.AUTH_KEY }}
      run: |
        mkdir -p build
        
        # å¯åŠ¨å®¹å™¨
        docker run --rm \
          -v "${{ github.workspace }}:/work" \
          -w /work \
          -e AUTH_KEY \
          -e HOME=/home/pspdev \
          -e PATH="/home/pspdev/.local/bin:/home/pspdev/pspdev/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" \
          psp-builder \
          /bin/bash -c '
            set -e
            
            echo "ğŸ”§ Configuring Git safe directory..."
            git config --global --add safe.directory "*"

            uv venv
            
            echo "â¬‡ï¸ Downloading Translations..."
            make download_trans
            
            echo "ğŸš€ Starting Full Build..."
            make full_build
          '

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PSP-Translation-Build
        path: |
          build/bin/EBTRANS.BIN
          build/evs_report.json
        if-no-files-found: error