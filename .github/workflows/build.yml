name: Build PSP Translation with Custom Docker

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-in-docker:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Build Docker Image
      run: |
        docker build -t psp-builder .

    - name: Run Build inside Container
      # ã€é‡è¦ã€‘åœ¨è¿™é‡Œå°† Secrets æ˜ å°„ä¸º Runner çš„ç¯å¢ƒå˜é‡
      # è¿™æ · GitHub ä¼šè‡ªåŠ¨å¼€å¯æ—¥å¿—æ©ç ä¿æŠ¤
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        AUTH_TOKEN: ${{ secrets.AUTH_TOKEN }}
      run: |
        mkdir -p temp build
        
        # å¯åŠ¨å®¹å™¨
        # æ³¨æ„ä¸‹é¢çš„ -e å‚æ•°åªå†™äº†å˜é‡åï¼Œæ²¡æœ‰å†™å€¼
        # Docker ä¼šè‡ªåŠ¨è¯»å–ä¸Šé¢çš„ env ä¸­çš„å€¼ï¼Œè¿™æ ·å‘½ä»¤è¡Œé‡Œå°±ä¸ä¼šå‡ºç°æ˜æ–‡ Token
        docker run --rm \
          -v "${{ github.workspace }}:/work" \
          -w /work \
          -e HF_TOKEN \
          -e AUTH_TOKEN \
          -e HOME=/home/pspdev \
          -e PATH="/home/pspdev/.local/bin:/home/pspdev/pspdev/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" \
          psp-builder \
          /bin/bash -c '
            set -e
            
            echo "ğŸ”§ Configuring Git safe directory..."
            git config --global --add safe.directory /work
            git config --global --add safe.directory /work/third_party/pgftool
            git config --global --add safe.directory /work/third_party/pspdecrypt
            
            echo "ğŸ“¦ Installing additional runtime deps..."
            uv pip install --system huggingface_hub
            
            echo "â¬‡ï¸ Downloading ISO from Hugging Face..."
            mkdir -p temp
            # è¿™é‡Œçš„è„šæœ¬ä¼šç›´æ¥è¯»å–å®¹å™¨å†…çš„ HF_TOKEN ç¯å¢ƒå˜é‡
            huggingface-cli download anononon/anon ULJS00064.iso \
              --repo-type model \
              --token "$HF_TOKEN" \
              --local-dir temp \
              --local-dir-use-symlinks False
            
            echo "â¬‡ï¸ Downloading Translations..."
            # ã€é‡è¦ã€‘ç¡®ä¿ä½ çš„ scripts/paratranz/download.py èƒ½è¯»å– AUTH_TOKEN ç¯å¢ƒå˜é‡
            # æˆ–è€… Makefile ä¸­çš„ download_trans ç›®æ ‡å¯ä»¥æ¥æ”¶ç¯å¢ƒå˜é‡
            make download_trans
            
            echo "ğŸš€ Starting Full Build..."
            # æ‰§è¡Œæ„å»º
            make full_build
          '

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PSP-Translation-Build
        path: |
          build/bin/EBTRANS.BIN
          build/evs_report.json
        if-no-files-found: error